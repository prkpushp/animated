name: Upload BT Shorts

on:
  push:
    paths:
      - input-trigger.txt
  workflow_dispatch:
    inputs:
      run_id:
        description: "Run ID (optional). If empty, latest successful run is used."
        required: false
        type: string

permissions:
  contents: write

jobs:
  upload-to-youtube:
    runs-on: ubuntu-latest

    env:
      SOURCE_OWNER: prkpushp
      SOURCE_REPO: animated
      SOURCE_WORKFLOW_NAME: '^BT Shorts$'

      YTCI_OWNER: prkpushp
      YTCI_REPO: ytci
      YTCI_REF: main

      CHANNEL_CONFIG_PATH: ytci/bt/input.json

      CLIENT_SECRETS: ytci/scripts/client_secret.json
      TOKEN_PICKLE: token.pickle

    steps:
      - name: Checkout borderlinetheory repo
        uses: actions/checkout@v4

      - name: Checkout ytci (private)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.YTCI_OWNER }}/${{ env.YTCI_REPO }}
          token: ${{ secrets.CROSS_REPO_PAT }}
          ref: ${{ env.YTCI_REF }}
          path: ytci
          fetch-depth: 1

      - name: Verify YouTube OAuth files
        run: |
          set -euo pipefail
          test -f "${CLIENT_SECRETS}" || { echo "Missing ${CLIENT_SECRETS}"; exit 1; }
          test -f "${TOKEN_PICKLE}" || { echo "Missing ${TOKEN_PICKLE} at repo root"; exit 1; }

      - name: Install system tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip

      - name: Get latest successful run ID (BT Shorts)
        id: get_run
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
          INPUT_RUN_ID: ${{ inputs.run_id }}
        run: |
          set -euo pipefail

          if [ -n "${INPUT_RUN_ID:-}" ]; then
            echo "run_id=$INPUT_RUN_ID" >> "$GITHUB_OUTPUT"
            echo "Using provided run ID: $INPUT_RUN_ID"
            exit 0
          fi

          WORKFLOWS_JSON="$(curl -sS \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${SOURCE_OWNER}/${SOURCE_REPO}/actions/workflows")"

          WF_ID="$(echo "$WORKFLOWS_JSON" | jq -r \
            --arg RE "$SOURCE_WORKFLOW_NAME" \
            '.workflows[] | select((.name? // "") | test($RE)) | .id' | head -n 1)"

          if [ -z "${WF_ID:-}" ] || [ "$WF_ID" = "null" ]; then
            echo "No workflow matched: $SOURCE_WORKFLOW_NAME"
            echo "$WORKFLOWS_JSON" | jq -r '.workflows[] | [.id,.name,.path] | @tsv'
            exit 1
          fi

          RUN_JSON="$(curl -sS \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${SOURCE_OWNER}/${SOURCE_REPO}/actions/workflows/${WF_ID}/runs?status=success&per_page=1")"

          RUN_ID="$(echo "$RUN_JSON" | jq -r '.workflow_runs[0].id // empty')"

          if [ -z "${RUN_ID:-}" ]; then
            echo "No successful runs found for workflow_id=$WF_ID"
            exit 1
          fi

          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
          echo "Selected run_id=$RUN_ID"

      - name: Get artifact download URL
        id: get_artifact
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
        run: |
          set -euo pipefail

          ARTIFACTS_JSON="$(curl -sS \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${SOURCE_OWNER}/${SOURCE_REPO}/actions/runs/${{ steps.get_run.outputs.run_id }}/artifacts")"

          ARTIFACT_URL="$(echo "$ARTIFACTS_JSON" | jq -r '
            .artifacts
            | map(select(.name | startswith("bt-output-")))
            | sort_by(.created_at)
            | last
            | .archive_download_url // empty
          ')"

          if [ -z "${ARTIFACT_URL:-}" ] || [ "$ARTIFACT_URL" = "null" ]; then
            echo "No artifact found with prefix bt-output-"
            echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | [.name,.created_at] | @tsv' || true
            exit 1
          fi

          echo "artifact_url=$ARTIFACT_URL" >> "$GITHUB_OUTPUT"

      - name: Download artifact zip
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
        run: |
          set -euo pipefail
          curl -L -sS \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -o artifact.zip "${{ steps.get_artifact.outputs.artifact_url }}"

      - name: Unzip artifact
        run: |
          set -euo pipefail
          rm -rf downloaded-artifact
          mkdir -p downloaded-artifact
          unzip -o artifact.zip -d downloaded-artifact

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-auth google-auth-oauthlib google-api-python-client pytz

      - name: Upload all BT shorts
        env:
          CHANNEL_CONFIG: ${{ env.CHANNEL_CONFIG_PATH }}
        run: |
          set -euo pipefail
          touch uploaded.log

          SCHEDULE_TIME="$(jq -r '.youtube.schedule_time // "1400"' "$CHANNEL_CONFIG")"
          DAYS_AHEAD="$(jq -r '.youtube.days_ahead // 0' "$CHANNEL_CONFIG")"
          PRIVACY="$(jq -r '.youtube.privacy_status // "private"' "$CHANNEL_CONFIG")"
          STEP_SECONDS="$(jq -r '.youtube.schedule_step_seconds // 300' "$CHANNEL_CONFIG")"

          # HHMM <-> minutes helpers
          to_minutes() { echo $((10#$1 / 100 * 60 + 10#$1 % 100)); }
          to_hhmm() { printf "%04d" $(( ($1/60)*100 + ($1%60) )); }

          mapfile -t MP4S < <(find downloaded-artifact -type f -name "youtube_shorts_*.mp4" | sort)
          if [ "${#MP4S[@]}" -eq 0 ]; then
            echo "No youtube_shorts_*.mp4 found"
            exit 1
          fi

          CUR_MIN="$(to_minutes "$SCHEDULE_TIME")"

          for FILEPATH in "${MP4S[@]}"; do
            BASENAME="$(basename "$FILEPATH")"
            STEM="${BASENAME%.mp4}"

            if grep -qx "$BASENAME" uploaded.log; then
              echo "Already uploaded: $BASENAME"
              continue
            fi

            META_STEM="${STEM/youtube_shorts_/youtube_metadata_}"
            META="$(find downloaded-artifact -type f -name "${META_STEM}.json" | head -n 1 || true)"
            if [ -z "${META:-}" ]; then
              echo "No metadata json for $BASENAME"
              exit 1
            fi

            TITLE="$(jq -r '.title // ""' "$META")"
            DESC="$(jq -r '.description // ""' "$META")"
            TAGS="$(jq -r '.hashtags // [] | join(" ")' "$META")"
            DESCRIPTION="${DESC} ${TAGS}"

            THIS_HHMM="$(to_hhmm "$CUR_MIN")"

            python ytci/scripts/upload_youtube.py \
              --video "$FILEPATH" \
              --title "$TITLE" \
              --description "$DESCRIPTION" \
              --privacy "$PRIVACY" \
              --schedule_hhmm "$THIS_HHMM" \
              --days_ahead "$DAYS_AHEAD" \
              --client_secrets "${CLIENT_SECRETS}" \
              --token_pickle "${TOKEN_PICKLE}" \
              --channel_config "${CHANNEL_CONFIG}"

            echo "$BASENAME" >> uploaded.log

            CUR_MIN=$((CUR_MIN + STEP_SECONDS/60))
          done

      - name: Commit and push uploaded.log
        run: |
          set -euo pipefail
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add uploaded.log
          git commit -m "Update uploaded.log" || echo "No changes to commit"
          git push origin main
