name: Generate Veo3 Video and Store as Artifact

on:
  workflow_dispatch:

jobs:
  generate-veo3:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Set up Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}

      - name: Extract Project ID from Key JSON
        id: project-id
        run: |
          echo '${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}' > key.json
          echo "PROJECT_ID=$(jq -r .project_id key.json)" >> $GITHUB_ENV

      - name: Generate Veo 3 Video
        id: generate-video
        run: |
          set -e
          LOCATION_ID="us-central1"
          MODEL_ID="veo-3.0-fast-generate-preview"
          API_ENDPOINT="$LOCATION_ID-aiplatform.googleapis.com"
          STORAGE_URI="gs://helloranjan1/output/"

          ACCESS_TOKEN=$(gcloud auth print-access-token)

          cat > request.json <<EOF
          {
            "endpoint": "projects/$PROJECT_ID/locations/$LOCATION_ID/publishers/google/models/$MODEL_ID",
            "instances": [
              {
                "prompt": "Two people standing near a tea stall in the evening. One looks curious, the other is confident. The sky is warm orange. Include subtitles in Hindi.\n\nDialogue:\nPerson 1: \"Yeh AI kya sach mein insaan ki madad karta hai?\"\nPerson 2 (smiling): \"Bilkul! Samay bachata hai, aur kaam bhi smart banata hai.\""
              }
            ],
            "parameters": {
              "aspectRatio": "16:9",
              "sampleCount": 1,
              "durationSeconds": "8",
              "personGeneration": "allow_adult",
              "addWatermark": true,
              "includeRaiReason": true,
              "generateAudio": true,
              "resolution": "720p",
              "storageUri": "$STORAGE_URI"
            }
          }
          EOF

          echo "üé¨ Submitting Veo 3 generation request..."
          OPERATION_ID=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            "https://${API_ENDPOINT}/v1/projects/${PROJECT_ID}/locations/${LOCATION_ID}/publishers/google/models/${MODEL_ID}:predictLongRunning" \
            -d @request.json | jq -r '.name')

          echo "operation_id=$OPERATION_ID" >> $GITHUB_OUTPUT

      - name: Poll Until Video is Ready
        id: poll-video
        run: |
          echo "Polling for operation completion..."
          for i in {1..20}; do
            RESPONSE=$(curl -s \
              -H "Authorization: Bearer $(gcloud auth print-access-token)" \
              "https://us-central1-aiplatform.googleapis.com/v1/${{ steps.generate-video.outputs.operation_id }}")

            echo "$RESPONSE" > response.json

            DONE=$(jq -r '.done' response.json)
            if [ "$DONE" == "true" ]; then
              echo "‚úÖ Operation complete"
              cp response.json operation_response.json
              break
            fi

            echo "‚è≥ Still processing... waiting 10s"
            sleep 10
          done

      - name: Download Video from GCS
        id: download
        run: |
          mkdir -p video_output
          VIDEO_URI=$(jq -r '.response.predictions[0].videoUri' operation_response.json)
          echo "üì• Downloading from: $VIDEO_URI"

          gsutil cp "$VIDEO_URI" video_output/veo3_output.mp4

      - name: Upload Video as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: veo3-video
          path: video_output/veo3_output.mp4
