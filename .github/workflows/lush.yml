name: Generate Veo3 Video

on:
  workflow_dispatch:

jobs:
  generate-veo3-video:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'beta'

      - name: Generate video using Veo 3
        id: generate-veo3
        run: |
          set -e
          mkdir -p output

          # Save the secret to a file
          echo "${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}" > key.json

          # Extract project_id from key.json
          PROJECT_ID=$(jq -r '.project_id' key.json)
          LOCATION_ID="us-central1"
          API_ENDPOINT="${LOCATION_ID}-aiplatform.googleapis.com"
          MODEL_ID="veo-3.0-fast-generate-preview"

          # Authenticate to Google Cloud
          gcloud auth activate-service-account --key-file=key.json
          gcloud config set project "$PROJECT_ID"

          ACCESS_TOKEN=$(gcloud auth print-access-token)

          # Prepare the Veo3 request JSON
          cat > request.json << 'EOF'
          {
            "endpoint": "projects/PROJECT_ID_PLACEHOLDER/locations/us-central1/publishers/google/models/veo-3.0-fast-generate-preview",
            "instances": [
              {
                "prompt": "Two people standing near a tea stall in the evening. One looks curious, the other is confident. The sky is warm orange. Include subtitles in Hindi.\n\nDialogue:\nPerson 1: \"Yeh AI kya sach mein insaan ki madad karta hai?\"\nPerson 2 (smiling): \"Bilkul! Samay bachata hai, aur kaam bhi smart banata hai.\""
              }
            ],
            "parameters": {
              "aspectRatio": "16:9",
              "sampleCount": 2,
              "durationSeconds": "8",
              "personGeneration": "allow_adult",
              "addWatermark": true,
              "includeRaiReason": true,
              "generateAudio": true,
              "resolution": "720p"
            }
          }
          EOF

          # Replace placeholder with actual project ID
          sed -i "s/PROJECT_ID_PLACEHOLDER/$PROJECT_ID/g" request.json

          echo "ðŸŽ¬ Sending request to Veo 3..."

          OPERATION_RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://${API_ENDPOINT}/v1/projects/${PROJECT_ID}/locations/${LOCATION_ID}/publishers/google/models/${MODEL_ID}:predictLongRunning" \
            -d @request.json)

          OPERATION_ID=$(echo "$OPERATION_RESPONSE" | jq -r '.name')

          echo "ðŸ†” OPERATION_ID: $OPERATION_ID"
          echo "operation_id=$OPERATION_ID" >> "$GITHUB_OUTPUT"
