
- name: Generate video 3
  id: generate-veo3
  run: |
    set -e
    mkdir -p output

    echo "${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}" > key.json

    # Extract project_id from key.json
    PROJECT_ID=$(jq -r '.project_id' key.json)
    LOCATION_ID="us-central1"
    API_ENDPOINT="${LOCATION_ID}-aiplatform.googleapis.com"
    MODEL_ID="veo-3.0-fast-generate-preview"

    # Authenticate
    gcloud auth activate-service-account --key-file=key.json
    gcloud config set project "$PROJECT_ID"

    ACCESS_TOKEN=$(gcloud auth print-access-token)

    # Prepare request.json
    cat <<EOF > request.json
    {
      "endpoint": "projects/${PROJECT_ID}/locations/${LOCATION_ID}/publishers/google/models/${MODEL_ID}",
      "instances": [
        {
          "prompt": "Two people standing near a tea stall in the evening. One looks curious, the other is confident. The sky is warm orange. Include subtitles in Hindi.\\n\\nDialogue:\\nPerson 1: \\\"Yeh AI kya sach mein insaan ki madad karta hai?\\\"\\nPerson 2 (smiling): \\\"Bilkul! Samay bachata hai, aur kaam bhi smart banata hai.\\\""
        }
      ],
      "parameters": {
        "aspectRatio": "16:9",
        "sampleCount": 2,
        "durationSeconds": "8",
        "personGeneration": "allow_adult",
        "addWatermark": true,
        "includeRaiReason": true,
        "generateAudio": true,
        "resolution": "720p"
      }
    }
EOF

    # Send the video generation request
    echo "ðŸŽ¬ Sending request to Veo 3..."

    OPERATION_RESPONSE=$(curl -s -X POST \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer $ACCESS_TOKEN" \
      "https://${API_ENDPOINT}/v1/projects/${PROJECT_ID}/locations/${LOCATION_ID}/publishers/google/models/${MODEL_ID}:predictLongRunning" \
      -d @request.json)

    # Extract operation ID from response
    OPERATION_ID=$(echo "$OPERATION_RESPONSE" | jq -r '.name')

    echo "ðŸ†” OPERATION_ID: $OPERATION_ID"
    echo "operation_id=$OPERATION_ID" >> $GITHUB_OUTPUT
