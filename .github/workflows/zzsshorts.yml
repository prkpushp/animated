name: Generate zipzoom 

on:
  schedule:
    - cron: '30 00 * * *' # 6,9 AM IST (00:30 AM UTC)
  workflow_dispatch: # Allows manual triggering

jobs:
  generate-video:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}
          create_credentials_file: true

      # Debug: Check service account key file
      - name: Debug service account key
        run: |
          if [ -f "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
            echo "Service account key file found at $GOOGLE_APPLICATION_CREDENTIALS"
            cat $GOOGLE_APPLICATION_CREDENTIALS | jq .client_email
          else
            echo "Error: Service account key file not found"
            exit 1
          fi

      # Verify authentication
      - name: Verify Google Cloud authentication
        run: |
          gcloud auth list
          if ! gcloud auth print-access-token; then
            echo "Error: Authentication failed"
            exit 1
          fi
          echo "Authentication successful"
          export PROJECT_ID=$(jq -r .project_id < "${{ env.GOOGLE_APPLICATION_CREDENTIALS }}")
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV

      # Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq google-cloud-cli
          gsutil cp gs://research-484112/output/12267221869252396931/sample_0.mp4 ./videos/sample_0.mp4
          sleep 100
          


      # Run script
      - name: Run video generation script
        run: |
          chmod +x zzs/generate_veo2_video_locally_with_animated_animals_and_music.sh
          ./zzs/generate_veo2_video_locally_with_animated_animals_and_music.sh

      # Upload video as artifact
      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        with:
          name: animated-video-${{ github.run_id }}-${{ github.run_number }}
          path: ./videos/*.mp4
          retention-days: 7

      - name: Write run ID to repo
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
          RUN_ID: ${{ github.run_id }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
          git clone https://x-access-token:${GH_TOKEN}@github.com/prkpushp/zipzoomstory.git
          cd zipzoomstory
      
          echo "Run ID: ${RUN_ID}" >> input-trigger.txt
      
          git add input-trigger.txt
          git commit -m "Update input-trigger.txt with run ID ${RUN_ID}"
          git push
                  
